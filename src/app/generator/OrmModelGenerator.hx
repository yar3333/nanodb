package generator;

import orm.Db;
import php.Global;
import php.TypedArray;
import php.Syntax;
using php.StringToolsNative;

class OrmModelGenerator 
{
	public function new() {}
	
	public function make(db:Db, table:OrmTable, customOrmClassName:String, outPath:String, positions:OrmPositions) : Void
	{
		Log.start(table.tableName + " => " + table.customModelClassName);
		
		var vars = OrmTools.fields2vars(table.tableName, db.connection.getFields(table.tableName), positions);
		
		var autogeneratedModel = getAutogenModel(table.tableName, vars, table.autogeneratedModelClassName, customOrmClassName);
		var destFileName = outPath + table.autogeneratedModelClassName.replace(".", "/") + ".php";
		Tools.mkdir(Global.dirname(destFileName));
		Global.file_put_contents(destFileName, autogeneratedModel.toString());
		
		if (!Global.file_exists(outPath + "/" + table.customModelClassName.replace(".", "/") + ".php")) 
		{
			var customModel = getCustomModel(table.customModelClassName, table.autogeneratedModelClassName);
			var destFileName = outPath + table.customModelClassName.replace(".", "/") + ".php";
			Tools.mkdir(Global.dirname(destFileName));
			Global.file_put_contents(destFileName, customModel.toString());
		}
		
		Log.finishSuccess();
	}
	
	function getAutogenModel(table:String, vars:TypedArray<OrmPhpVar>, modelClassName:String, customOrmClassName:String) : PhpClass
	{
		var klass = new PhpClass(modelClassName, "nanodb.orm.Entity");
		
		klass.addComment("// This file is autogenerated. Do not edit!");
		
		klass.addVar(new PhpVar("db", Tools.toPhpType("nanodb.orm.Db")), "protected");
		klass.addMethod("db__fromDb", Syntax.arrayDecl(), "void", "", "protected");
		klass.addMethod("db__toDb", Syntax.arrayDecl(), "void", "", "protected");
		klass.addMethod("db__fromJson", Syntax.arrayDecl(), "void", "", "protected");
		klass.addMethod("db__toJson", Syntax.arrayDecl(), "void", "", "protected");
		
		klass.addVar(new PhpVar("orm", Tools.toPhpType(customOrmClassName)), "protected");
		klass.addMethod("orm__fromDb", Syntax.arrayDecl(), "void", "", "protected");
		klass.addMethod("orm__toDb", Syntax.arrayDecl(), "void", "", "protected");
		klass.addMethod("orm__fromJson", Syntax.arrayDecl(), "void", "", "protected");
		klass.addMethod("orm__toJson", Syntax.arrayDecl(), "void", "", "protected");
		
		Syntax.foreach(vars, function(_, v:OrmPhpVar)
		{
			klass.addVar(v);
			
			if (v.haxeType == "\\DateTime")
			{
				klass.addMethod
				(
					v.haxeName + "__fromDb",
					Syntax.arrayDecl(new PhpVar("data", "array")),
					null, 
					"return $data['" + v.name + "'] !== null ? new \\DateTime($data['" + v.name + "']) : null;",
					"protected"
				);
			}
			else if (v.haxeType == "bool")
			{
				klass.addMethod
				(
					v.haxeName + "__fromDb",
					Syntax.arrayDecl(new PhpVar("data", "array")),
					null, 
					"return $data['" + v.name + "'] !== null ? (bool)$data['" + v.name + "'] : null;",
					"protected"
				);
			}
		});
		
		klass.addMethod(
			  "__construct"
			, Syntax.arrayDecl(
				new PhpVar("db", Tools.toPhpType("nanodb.orm.Db")),
				new PhpVar("orm", Tools.toPhpType(customOrmClassName)) 
			  )
			, null
			, "$this->db = $db;\n$this->orm = $orm;"
		);
        
        if (vars.exists(function(v) return v.isKey) && vars.exists(function(v) return !v.isKey))
		{
			var settedVars = vars.filter(function(v) return !v.isKey && !v.isAutoInc);
			if (settedVars.length > 0)
			{
				klass.addMethod(
					"set",
					cast settedVars,
					"void",
					settedVars.map(function(v) return "$this->" + v.haxeName + " = $" + v.haxeName + ";").join("\n")
				);
			}
			
			var savedVars = vars.filter(function(v) return !v.isKey);
			var whereVars = vars.filter(function(v) return v.isKey);
			klass.addMethod(
				"save",
				Syntax.arrayDecl(),
				"void",
				  "$data = $this->dbSerialize([ " + savedVars.map(function(x) return "'" + x.name + "'").join(", ") + " ]);\n"
				+ "$sets = []; foreach ($data as $k => $v) $sets[] = \"`$k` = \" . $this->db->quote($v);\n"
				+ "\n"
				+ "$keys = $this->dbSerialize([ " + whereVars.map(function(x) return "'" + x.name + "'").join(", ") + " ]);\n"
				+ "$wheres = []; foreach ($keys as $k => $v) $wheres[] = \"`$k` = \" . $this->db->quote($v);\n"
				+ "\n"
				+ "$this->db->query(\n"
				    + "\t 'UPDATE `" + table + "` SET ' . implode(', ', $sets) . ' WHERE ' . implode(' AND ', $wheres) . ' LIMIT 1'"
				+ "\n);"
			);
		}
		
		klass.addMethod(
			  "dbSerialize"
			, Syntax.arrayDecl(new PhpVar("properties", "array", "null"))
			, "array"
			, "if (!isset($properties)) $properties = [ " + vars.map(function(x) return "'" + x.haxeName + "'").join(", ") + " ];\n"
			+ "return parent::dbSerialize($properties);"
		);
		
		klass.addMethod(
			  "dbDeserialize"
			, Syntax.arrayDecl(new PhpVar("data", "array"), new PhpVar("properties", "array", "null"))
			, "void"
			, "if (!isset($properties)) $properties = [ " + vars.map(function(x) return "'" + x.haxeName + "'").join(", ") + " ];\n"
			+ "parent::dbDeserialize($data, $properties);"
		);
		
		return klass;
	}

	function getCustomModel(customModelClassName:String, autogeneratedModelClassName:String) : PhpClass
	{
		return new PhpClass(customModelClassName, autogeneratedModelClassName);
	}
}