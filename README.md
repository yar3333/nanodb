nanodb
======
Small, fast and free database-first ORM for PHP 7.2+


Install
-------
```sh
composer require nanodb/nanodb
```


Generate PHP classes (models & managers) from database
------------------------------------------------------
```sh
# windows
php vendor\nanodb\nanodb\cli.php <databaseConnectionString> [options]

#linux
php vendor/nanodb/nanodb/cli.php <databaseConnectionString> [options]
```

`<databaseConnectionString>` must be in URI format: `mysql://user:password@host:port/database`

Options:
```
-a, --autogenerated-namespace  Namespace for autogenerated classes.
                               Default is 'models\autogenerated'.

-c, --custom-namespace         Namespace for your custom classes.
                               Default is 'models'.

-o, --out-path                 This is a base directory path for generated files.

-i, --ignore-table             Table name to ignore.

-nim, --no-instantiate-manager Table name to skip manager creating in autogenerated Orm class.
                               You can use this switch for your managers with a custom constructors.
                               In this case you must instantiate these managers manually
                               (in regular case - in your custom Orm constructor).

-pf, --position-field          Field name treated as record number (1, 2, 3, ...).
                               Values of such fields will be autocalculated on records creating.
                               Can be specified in next forms:
                                `field` or `*.field` - to specify fields in any table;
                                `table.field` - to specify field in specified table only.
                               Default is `position`.
```

Generator will look to:
 * primary keys
 * autoincrements
 * foreign keys
 * indexes


Using code example
------------------

Assumed you have a `users` table in your database with fields:
 * `id` int autoincrement
 * `login` varchar unique index
 * `role` varchar index
 * `status` int

```php
use \nanodb\orm\Db;
use \models\Orm;

$db = new Db("mysql://root:123456@localhost/testdb");
$orm = new Orm($db);

# create user in database
$user = $orm->user->create($login, $role, $status);

# get user by ID
$user = $orm->user->get(10);

# field name and value will be automatically quoted
$users = $orm->user->whereField("status", "=", 2)->findMany(); 

# field name and value will be automatically quoted
$users = $orm->user->whereField("status", "IN", [2, 3])->findMany();

# prevent quoting by sqlTextRaw()
$users = $orm->user->whereField("status", "=", $db->sqlTextRaw("1 + 1"))->findMany(); 

# find by raw SQL condition
$users = $orm->user->where("status = 2")->findMany();

# find first by raw SQL
$user = $orm->user->getOne("SELECT * FROM `users` WHERE `status` = " . $db->quote($statusFromRequest));

# find many by raw SQL
$users = $orm->user->getMany("SELECT * FROM `users` WHERE `status` = 2");

# find by raw SQL with binding parameters
$users = $orm->user->getMany("SELECT * FROM `users` WHERE `status` = {myStatus}", [
	"myStatus" => $statusFromRequest 
]);

# get count of all users
$count = $orm->user->query()->count();

# get count of users by complex condition
$count = $orm->user->whereField("status", "=", 1)
                   ->whereField("role", "=", "support")
                   ->count();

# remove user by ID
$orm->user->delete(10);

# if you have unique index by `login` field, then you can do next
$user = $orm->user->getByLogin('root');

# if you have regular index by `role` field, then you can do next
$users = $orm->user->getByRole('support');

# if you have a `books` table with `user_id` field (with a foreign key), then you can do next
$books = $orm->book->getByUserId(10);

# get a user and fix `status`
$user = $orm->user->get(10);
$user->status = 5;
$user->save();

# save data received from external
$user = $orm->user->newModelFromJson($request);
# here - check field types and validate data
$orm->user->add($user); # insert to database

$user = $orm->user->newEmptyModel();
$user->login = "hero";
$user->role = "admin";
$user->status = 1;
$orm->user->add($user); # insert to database
```
